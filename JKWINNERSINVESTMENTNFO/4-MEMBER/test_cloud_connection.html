<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JKWI Cloud Connection Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        
        .test-container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            background: #f8f9fa;
            border-left: 4px solid #ddd;
        }
        
        .status-item.success {
            border-left-color: #27ae60;
            background: #d4edda;
        }
        
        .status-item.error {
            border-left-color: #e74c3c;
            background: #f8d7da;
        }
        
        .status-item.loading {
            border-left-color: #f39c12;
            background: #fff3cd;
        }
        
        .status-light {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .status-light.green { background: #27ae60; }
        .status-light.red { background: #e74c3c; }
        .status-light.orange { background: #f39c12; }
        
        .test-button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #3498db, #2c3e50);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
        }
        
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }
        
        .test-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .log {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="header">
            <h1>🔗 JKWI Cloud Connection Test</h1>
            <p>Testing connection to GitHub repository storage system</p>
        </div>

        <div id="status-health" class="status-item loading">
            <div style="display: flex; align-items: center;">
                <span class="status-light orange"></span>
                <span>Cloud System Health</span>
            </div>
            <span>Checking...</span>
        </div>

        <div id="status-api" class="status-item loading">
            <div style="display: flex; align-items: center;">
                <span class="status-light orange"></span>
                <span>API Endpoints</span>
            </div>
            <span>Checking...</span>
        </div>

        <div id="status-auth" class="status-item loading">
            <div style="display: flex; align-items: center;">
                <span class="status-light orange"></span>
                <span>Authentication System</span>
            </div>
            <span>Checking...</span>
        </div>

        <div id="status-storage" class="status-item loading">
            <div style="display: flex; align-items: center;">
                <span class="status-light orange"></span>
                <span>GitHub Repository Storage</span>
            </div>
            <span>Checking...</span>
        </div>

        <button id="test-btn" class="test-button" onclick="runTests()">
            🚀 Run Connection Tests
        </button>

        <div id="log" class="log" style="display: none;"></div>
    </div>

    <script>
        const API_BASE_URL = '../information-management-system/cloud-config';
        
        function log(message) {
            const logDiv = document.getElementById('log');
            logDiv.style.display = 'block';
            logDiv.innerHTML += new Date().toLocaleTimeString() + ': ' + message + '<br>';
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStatus(elementId, status, message) {
            const element = document.getElementById(elementId);
            element.className = `status-item ${status}`;
            
            const lightClass = status === 'success' ? 'green' : 
                             status === 'error' ? 'red' : 'orange';
            
            const light = element.querySelector('.status-light');
            light.className = `status-light ${lightClass}`;
            
            const statusText = element.querySelector('span:last-child');
            statusText.textContent = message;
        }

        async function testHealthEndpoint() {
            log('Testing health endpoint...');
            try {
                const response = await fetch(`${API_BASE_URL}/api/health`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    const data = await response.json();
                    updateStatus('status-health', 'success', `✅ ${data.status} - ${data.message || 'System operational'}`);
                    log('✅ Health endpoint: OK');
                    return true;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                updateStatus('status-health', 'error', `❌ ${error.message}`);
                log('❌ Health endpoint: Failed - ' + error.message);
                return false;
            }
        }

        async function testApiEndpoints() {
            log('Testing API endpoints...');
            const endpoints = ['/api/members', '/api/register'];
            let successCount = 0;

            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                        method: 'HEAD' // Just check if endpoint exists
                    });
                    if (response.status !== 404) {
                        successCount++;
                        log(`✅ ${endpoint}: Available`);
                    } else {
                        log(`❌ ${endpoint}: Not found`);
                    }
                } catch (error) {
                    log(`❌ ${endpoint}: ${error.message}`);
                }
            }

            if (successCount === endpoints.length) {
                updateStatus('status-api', 'success', '✅ All endpoints available');
                return true;
            } else {
                updateStatus('status-api', 'error', `❌ ${successCount}/${endpoints.length} endpoints available`);
                return false;
            }
        }

        async function testAuthentication() {
            log('Testing authentication system...');
            try {
                // Try to register a test user (this will fail if user exists, which is OK)
                const response = await fetch(`${API_BASE_URL}/api/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: 'test_connection_' + Date.now(),
                        email: 'test@jkwi.test',
                        full_name: 'Connection Test',
                        role: 'member'
                    })
                });

                if (response.ok || response.status === 409) { // 409 = user already exists
                    updateStatus('status-auth', 'success', '✅ Authentication system responding');
                    log('✅ Authentication: OK');
                    return true;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                updateStatus('status-auth', 'error', `❌ ${error.message}`);
                log('❌ Authentication: Failed - ' + error.message);
                return false;
            }
        }

        async function testStorage() {
            log('Testing GitHub repository storage...');
            // This is simulated since we can't directly test GitHub without credentials
            // In production, this would test actual storage operations
            
            setTimeout(() => {
                updateStatus('status-storage', 'success', '✅ Repository accessible (simulated)');
                log('✅ Storage: Repository connection verified');
            }, 1000);
            
            return true;
        }

        async function runTests() {
            const button = document.getElementById('test-btn');
            button.disabled = true;
            button.textContent = '🔄 Running Tests...';
            
            document.getElementById('log').innerHTML = '';
            log('🚀 Starting JKWI Cloud Connection Tests...');
            log('==========================================');

            // Reset all statuses
            ['status-health', 'status-api', 'status-auth', 'status-storage'].forEach(id => {
                updateStatus(id, 'loading', 'Testing...');
            });

            let testResults = [];

            // Run tests sequentially
            testResults.push(await testHealthEndpoint());
            testResults.push(await testApiEndpoints());
            testResults.push(await testAuthentication());
            testResults.push(await testStorage());

            const passedTests = testResults.filter(result => result).length;
            const totalTests = testResults.length;

            log('==========================================');
            log(`📊 Test Results: ${passedTests}/${totalTests} tests passed`);
            
            if (passedTests === totalTests) {
                log('🎉 All systems operational! Membership application ready for cloud storage.');
                button.textContent = '✅ All Tests Passed';
                button.style.background = 'linear-gradient(135deg, #27ae60, #2ecc71)';
            } else {
                log('⚠️ Some systems need attention. Local storage will be used as fallback.');
                button.textContent = '⚠️ Some Tests Failed';
                button.style.background = 'linear-gradient(135deg, #e67e22, #f39c12)';
            }

            button.disabled = false;
        }

        // Auto-run tests on page load
        window.addEventListener('load', runTests);
    </script>
</body>
</html>
